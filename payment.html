<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
    <link rel="stylesheet" href="style.css"> 
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="payment.js" defer></script> 
</head>
<body>
    <div class="modal-overlay active" id="paymentPageOverlay">
        <div class="modal-content">
            <h2 id="paymentTitle" class="modal-title">Payment</h2>
            <div id="paymentDetails" class="modal-body">
                </div>
            <div class="powered-by">
                <p>Powered by milaaje</p>
            </div>
        </div>
    </div>
</body>

</html>
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
// payment-page.js

// --- Configuration Constants (Copy from main.js) ---
const PAYSTACK_PUBLIC_KEY = 'pk_test_505cf99670d464176e9fb5e2c3da0a4e3a240094';
const FLUTTERWAVE_PUBLIC_KEY = 'FLWPUBK-55e5d0e754e7da9baacac6e2cb4e04ac-X';
const EXCHANGERATE_API_KEY = 'd852fe1a5c2d4ef9a40400ed';
const FORMSPREE_SINGLE_ENDPOINT_ID = 'xovdrlby'; 
const REGISTRATION_PAYMENT_NGN = 1500;
const RENEWAL_PAYMENT_NGN = 1500;
const REFERRAL_BONUS_NGN = 1500;
const FLUTTERWAVE_COUNTRIES_MAP = {
    'NG': { currency: 'NGN', channels: ['card', 'banktransfer', 'ussd', 'qr'] },
    'GH': { currency: 'GHS', channels: ['mobilemoneyghana'] },
    'KE': { currency: 'KES', channels: ['mpesa'] },
    'UG': { currency: 'UGX', channels: ['mobilemoneyuganda'] },
    'TZ': { currency: 'TZS', channels: ['mobilemoneytzpesa'] },
    'ZM': { currency: 'ZMW', channels: ['mobilemoneyzambia'] },
    'RW': { currency: 'RWF', channels: ['mobilemoneyrwanda'] },
    'ZA': { currency: 'ZAR', channels: ['card', 'eft'] },
    'CI': { currency: 'XOF', channels: ['mobilemoneyfranco'] },
    'SN': { currency: 'XOF', channels: ['mobilemoneyfranco'] },
    'CM': { currency: 'XAF', channels: ['mobilemoneyfranco'] },
};
const currencySymbols = {
    NGN: '₦', GHS: '₵', KES: 'KSh', ZAR: 'R', UGX: 'USh', TZS: 'TSh', RWF: 'RF', XOF: 'CFA', XAF: 'FCFA'
};

// --- Utility Functions (Copy from main.js) ---
function currencySymbol(code) { return currencySymbols[code] || code; }
async function getConvertedAmount(amountInNGN, targetCurrencyCode) {
    if (targetCurrencyCode === 'NGN') return amountInNGN;
    const apiUrl = `https://v6.exchangerate-api.com/v6/${EXCHANGERATE_API_KEY}/latest/NGN`;
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Failed to fetch exchange rates.');
        const data = await response.json();
        if (data.result === 'success' && data.conversion_rates && data.conversion_rates[targetCurrencyCode]) {
            const rateNGNToTarget = data.conversion_rates[targetCurrencyCode];
            return Math.round(amountInNGN * rateNGNToTarget);
        } else {
            throw new Error('Invalid API response or currency not supported.');
        }
    } catch (error) {
        console.error('Error fetching conversion rate:', error);
        alert(`Failed to convert currency to ${targetCurrencyCode}. Proceeding with NGN payment as fallback.`);
        return amountInNGN;
    }
}
async function sendDataToFormspree(endpointId, data) {
    try {
        const response = await fetch(`https://formspree.io/f/${endpointId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        if (response.ok) console.log('Data sent to Formspree:', data);
        else console.error('Failed to send data to Formspree:', response.status, await response.text());
    } catch (error) {
        console.error('Network error sending data to Formspree:', error);
    }
}
function handlePaymentSuccess(paymentType, transactionReference, paymentDetails, paymentGatewayUsed) {
    const successParams = new URLSearchParams();
    successParams.append('paymentStatus', 'success');
    successParams.append('paymentType', paymentType);
    successParams.append('transactionRef', transactionReference);
    
    // Add payment gateway to details
    paymentDetails.paymentGatewayUsed = paymentGatewayUsed;

    successParams.append('paymentData', JSON.stringify(paymentDetails));

    // Construct the redirect URL with the new params
    const redirectUrl = `${paymentDetails.returnUrl}&${successParams.toString()}`;
    window.location.href = redirectUrl;

    // Send data to Formspree
    const formspreeData = {
        _form_type: 'Payment Success',
        ...paymentDetails,
        paymentGateway: paymentGatewayUsed,
        transactionReference: transactionReference,
        timestamp: new Date().toISOString()
    };
    sendDataToFormspree(FORMSPREE_SINGLE_ENDPOINT_ID, formspreeData);
}

// --- Payment Gateway Handlers (Corrected) ---
function handlePaystackPayment(amount, email, name, phone, country, paymentType, returnUrl, otherDetails) {
    if (!email || !name || !amount) {
        alert('Invalid payment details provided.');
        return;
    }

    const amountInKobo = amount * 100;

    const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: email,
        amount: amountInKobo,
        ref: '' + Math.floor((Math.random() * 1000000000) + 1), // unique ref
        metadata: {
            custom_fields: [
                { display_name: "Full Name", variable_name: "full_name", value: name },
                { display_name: "Phone Number", variable_name: "phone_number", value: phone },
                { display_name: "Payment Type", variable_name: "payment_type", value: paymentType },
            ]
        },
        callback: function(response) {
            if (response.status === 'success') {
                handlePaymentSuccess(paymentType, response.reference, otherDetails, 'Paystack');
            } else {
                alert('Payment failed or was cancelled.');
            }
        },
        onClose: function() {
            console.log('Payment window closed.');
        }
    });

    handler.openIframe();
}

function handleFlutterwavePayment(amount, email, phone, name, country, paymentType, targetCurrencyCode, returnUrl, otherDetails) {
    if (!email || !name || !amount || !targetCurrencyCode) {
        alert('Invalid payment details provided.');
        return;
    }

    const countryInfo = FLUTTERWAVE_COUNTRIES_MAP[country?.toUpperCase()] || { currency: 'NGN' };
    
    FlutterwaveCheckout({
        public_key: FLUTTERWAVE_PUBLIC_KEY,
        tx_ref: "TX" + Date.now(), // unique transaction reference
        amount: amount,
        currency: targetCurrencyCode,
        payment_options: countryInfo.channels.join(','),
        customer: {
            email: email,
            phone_number: phone,
            name: name,
        },
        customizations: {
            title: "Milaaje Payment",
            description: `Payment for ${paymentType}`,
            logo: "https://your-website.com/logo.png", // Replace with your logo
        },
        callback: function(data) {
            console.log(data);
            if (data.status === 'successful') {
                handlePaymentSuccess(paymentType, data.tx_ref, otherDetails, 'Flutterwave');
            } else {
                alert('Payment failed or was cancelled.');
            }
        },
        onclose: function() {
            console.log('Payment window closed.');
        }
    });
}


// --- Payment Page Logic (New) ---
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const paymentType = params.get('type');
    const amountInNGN = parseFloat(params.get('amount'));
    const returnUrl = params.get('returnUrl');
    const country = params.get('country');

    if (!paymentType || isNaN(amountInNGN) || !returnUrl) {
        document.getElementById('paymentDetails').innerHTML = `<p class="suspended-message">Invalid payment link. Please go back to the previous page.</p>`;
        return;
    }

    const name = params.get('name');
    const email = params.get('email');
    const phone = params.get('phone');
    
    const paymentDetails = {
        type: paymentType,
        amount: amountInNGN,
        email: email,
        name: name,
        phone: phone,
        country: country,
        returnUrl: returnUrl,
        handle: params.get('handle'),
        accessCode: params.get('accessCode'),
        referralHandle: params.get('referralHandle'),
        oldExpiry: params.get('oldExpiry')
    };

    renderPaymentOptions(paymentDetails);
});


async function renderPaymentOptions(details) {
    const paymentDetailsEl = document.getElementById('paymentDetails');
    const countryCode = details.country?.toUpperCase();
    const countryInfo = FLUTTERWAVE_COUNTRIES_MAP[countryCode];
    let convertedAmount = details.amount;

    if (countryInfo && countryInfo.currency !== 'NGN') {
        convertedAmount = await getConvertedAmount(details.amount, countryInfo.currency);
    }
    
    paymentDetailsEl.innerHTML = `
        <p class="note-text">You are about to pay for: <strong>${details.type.charAt(0).toUpperCase() + details.type.slice(1)}</strong></p>
        <p class="note-text">Amount: <strong>${currencySymbol(countryInfo?.currency || 'NGN')}${convertedAmount.toLocaleString('en-US')}</strong></p>
        <p class="note-text">Please choose a payment method:</p>
        <div class="action-buttons" style="flex-direction:column; gap:15px; margin-top:20px;">
        </div>
        <p class="chat-link">Can't pay with any of the above method? <a href="https://wa.me/2348027350284" target="_blank">Chat with me now let's get you in whichever way possible.</a></p>
    `;

    const buttonsContainer = paymentDetailsEl.querySelector('.action-buttons');
    
    if (countryCode === "NG") {
        buttonsContainer.innerHTML = `
            <button class="form-submit-btn" id="payWithPaystackBtn" style="background: linear-gradient(90deg, #1A1A2E, #25D366);">
                <img src="https://i.imgur.com/Us974zg.jpeg" alt="Paystack" style="height:24px; margin-right:10px;"> Pay with Paystack (Opay, Bank Transfer)
            </button>
            <button class="form-submit-btn" id="payWithFlutterwaveBtn" style="background: linear-gradient(90deg, #FFD700, #FFA500); color: #333;">
                <img src="https://i.imgur.com/ElPGTna.jpeg" alt="Flutterwave" style="height:24px; margin-right:10px;"> Pay with Flutterwave (Mobile Money, Card, etc.)
            </button>
        `;
        document.getElementById('payWithPaystackBtn').onclick = () => handlePaystackPayment(details.amount, details.email, details.name, details.phone, countryCode, details.type, details.returnUrl, details);
        document.getElementById('payWithFlutterwaveBtn').onclick = () => handleFlutterwavePayment(details.amount, details.email, details.phone, details.name, countryCode, details.type, 'NGN', details.returnUrl, details);
    } else if (countryInfo && countryInfo.channels.includes('mobilemoneyghana')) {
        buttonsContainer.innerHTML = `
            <button class="form-submit-btn" id="payWithFlutterwaveBtn" style="background: linear-gradient(90deg, #FFD700, #FFA500); color: #333;">
                <img src="https://i.imgur.com/ElPGTna.jpeg" alt="Flutterwave" style="height:24px; margin-right:10px;"> Pay with Flutterwave (Momo Ghana)
            </button>
        `;
        document.getElementById('payWithFlutterwaveBtn').onclick = () => handleFlutterwavePayment(convertedAmount, details.email, details.phone, details.name, countryCode, details.type, countryInfo.currency, details.returnUrl, details);
    } else if (countryInfo && countryInfo.channels.includes('mpesa')) {
        buttonsContainer.innerHTML = `
            <button class="form-submit-btn" id="payWithFlutterwaveBtn" style="background: linear-gradient(90deg, #FFD700, #FFA500); color: #333;">
                <img src="https://i.imgur.com/ElPGTna.jpeg" alt="Flutterwave" style="height:24px; margin-right:10px;"> Pay with Flutterwave (Mpesa Kenya)
            </button>
        `;
        document.getElementById('payWithFlutterwaveBtn').onclick = () => handleFlutterwavePayment(convertedAmount, details.email, details.phone, details.name, countryCode, details.type, countryInfo.currency, details.returnUrl, details);
    } else {
        buttonsContainer.innerHTML = `
            <button class="form-submit-btn" id="payWithPaystackBtn" style="background: linear-gradient(90deg, #1A1A2E, #25D366);">
                <img src="https://i.imgur.com/Us974zg.jpeg" alt="Paystack" style="height:24px; margin-right:10px;"> Pay with Paystack
            </button>
        `;
        document.getElementById('payWithPaystackBtn').onclick = () => handlePaystackPayment(details.amount, details.email, details.name, details.phone, countryCode, details.type, details.returnUrl, details);
    }
}

    
</script>
