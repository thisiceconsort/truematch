<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Modern Blog (All-in-One)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/brands.min.css">

    <style>
        /* 1. Global/Reset Styles */
        :root {
            /* Light Mode (Default) */
            --primary-color: #007bff; /* Blue for highlights/links */
            --secondary-color: #1a1a1a; /* Dark text */
            --background-color: #f8f9fa; /* Light grey/off-white */
            --card-bg: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', sans-serif;
            --max-content-width: 800px; /* Max width for single post content */
        }
        
        /* Night Mode Styles (Combination of Blue, Black, Gray) */
        body.night-mode {
            --primary-color: #4a90e2; /* Softer Blue */
            --secondary-color: #f1f1f1; /* Light text */
            --background-color: #121212; /* Dark background */
            --card-bg: #1e1e1e; /* Darker card background */
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.4); /* Stronger shadow */
            color: var(--secondary-color);
        }

        /* Night Mode Overrides */
        .night-mode .post-footer, 
        .night-mode .post-header-meta {
            color: #b0b0b0; /* Lighter grey for secondary text */
        }
        .night-mode .post-description {
            color: #b0b0b0;
        }
        .night-mode .post-footer {
            border-top: 1px solid #333;
        }
        .night-mode .post-card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .night-mode .post-social-bar .social-button {
            background: #2c2c2c;
            color: #f1f1f1;
        }
        .night-mode .post-social-bar .social-button:hover {
            background: var(--primary-color);
            color: white;
        }
        .night-mode .post-highlight {
            background-color: #1c2833;
            color: #f1f1f1;
            border-left: 5px solid var(--primary-color);
        }
        .night-mode .comments-thread {
            background-color: #2c2c2c;
        }
        .night-mode .comments-thread textarea {
            background-color: #333;
            color: white;
            border-color: #555;
        }
        .night-mode footer {
            color: #b0b0b0;
        }
        
        /* Modal Overrides (Toggling/Dark Mode) */
        .menu-modal .modal-section {
            display: none; /* HIDE ALL SECTIONS FOR TOGGLE LOGIC */
        }
        .menu-modal .modal-section.is-active {
            display: block; /* SHOW ONLY ACTIVE SECTION */
        }
        .night-mode .modal-content {
            background: var(--card-bg);
        }
        .night-mode .modal-section {
            border-bottom: 1px solid #333;
        }
        .night-mode .author-info-compact {
            background: #2c2c2c;
        }
        .night-mode .author-details p, 
        .night-mode .author-details a {
            color: #b0b0b0;
        }
        .night-mode .contact-social-icons a {
            color: #f1f1f1;
        }
        .night-mode .contact-details-compact {
            border: 1px solid #333;
        }
        .night-mode .contact-details-compact div {
            color: #f1f1f1;
        }

        /* --- NEW: LOGIN/REGISTER FORM STYLES --- */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 20px auto 30px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .night-mode .auth-form {
            background: #2c2c2c;
            border-color: #333;
        }
        .auth-form input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 1rem;
        }
        .night-mode .auth-form input {
            background-color: #333;
            color: white;
            border-color: #555;
        }
        .auth-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .auth-button:hover {
            background-color: #0056b3;
        }
        .auth-link-text {
            text-align: center;
            font-size: 0.9rem;
            color: #555;
        }
        .night-mode .auth-link-text {
            color: #b0b0b0;
        }
        .auth-link-text a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
        /* --- END OF LOGIN/REGISTER FORM STYLES --- */
        
        /* --- NEW: LOGIN PROMPT POPUP STYLES --- */
        .login-prompt-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--card-bg);
            color: var(--secondary-color);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 300px;
            transform: translateX(150%); /* Start off-screen */
            transition: transform 0.4s ease-in-out;
        }
        .night-mode .login-prompt-popup {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
        }
        .login-prompt-popup.show {
            transform: translateX(0);
        }
        .login-prompt-popup i {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        .login-prompt-popup button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: auto;
            flex-shrink: 0;
        }
        .login-prompt-popup button:hover {
            background: #0056b3;
        }
        /* --- END OF LOGIN PROMPT POPUP STYLES --- */

        /* --- NEW: VIBRATE ANIMATION --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        /* ADDED: Vibrate effect now on the login pop-up */
        .login-prompt-popup.vibrate {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--secondary-color);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s; /* Smooth theme transition */
        }
        
        /* Overlay when menu is open on mobile */
        
        body.menu-open {
            overflow: hidden;
        }
        body.menu-open::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1004; 
        }

        /* ----------------------------------- */
        /* 2. Header and Navigation */
        /* ----------------------------------- */
        .main-header {
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .night-mode .main-header {
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        
        /* New Wrapper for Desktop Navigation and Toggle */
        .header-right-content {
            display: contents; /* Allows children to participate in flex layout on mobile */
            gap: 20px;
        }

        .blog-title {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--secondary-color);
            cursor: pointer;
        }

        .blog-title strong {
            color: var(--primary-color);
        }

        /* --- Stylish Unequal Hamburger Menu --- */
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            position: relative;
            z-index: 1070;
        }

        .line {
            display: block;
            height: 3px;
            background: var(--secondary-color);
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;
        }

        .line-top { width: 100%; }
        .line-middle { width: 65%; align-self: center; } 
        .line-bottom { width: 85%; align-self: flex-start; }

        .hamburger.is-active .line-top {
            transform: translateY(11px) rotate(45deg);
            width: 100%;
        }
        .hamburger.is-active .line-middle {
            opacity: 0;
            transform: translateX(-30px);
        }
        .hamburger.is-active .line-bottom {
            transform: translateY(-11px) rotate(-45deg);
            width: 100%;
        }

        /* --- Navigation Menu (Off-Canvas - Mobile) --- */
        .nav-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background: var(--secondary-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1200;
            display: flex; /* Flex for stacking ul and toggle block */
            flex-direction: column;
        }

        .nav-menu.is-open {
            transform: translateX(0);
        }
        
        /* --- NEW: Stylish User Profile Header in Mobile Nav Menu --- */
        .user-profile-header {
            background: var(--primary-color); /* Primary color background */
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            min-height: 80px;
            flex-shrink: 0;
        }
        
        .user-profile-header .user-info-placeholder,
        .user-profile-header .user-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .user-profile-header .user-avatar {
            width: 50px; /* Slightly larger avatar */
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid white;
            flex-shrink: 0;
        }

        .user-profile-header .user-name {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .user-profile-header .user-email {
            font-size: 0.85rem;
            opacity: 0.8;
            word-wrap: break-word; /* Ensure long emails don't overflow */
        }
        /* --- END OF USER PROFILE HEADER STYLES --- */
        
        .nav-menu ul {
            list-style: none;
            padding: 20px 0;
            /* margin-top: 40px; <-- REMOVED: Now follows the profile header */
            z-index: 1300;
            flex-grow: 1; /* Allows list to fill available space */
        }

        .nav-menu li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--card-bg);
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s;
        }
        
        .nav-menu li a i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .nav-menu li a:hover {
            background-color: #333;
            color: var(--primary-color);
        }
        
        .nav-menu li a:hover i {
            color: var(--primary-color);
        }

        /* --- Theme Toggle Switch Styles (Mobile: Inside Nav Menu Footer) --- */
        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            width: 100%;
            background-color: #333;
            border-top: 1px solid #444;
            color: white;
            flex-shrink: 0;
        }
        .toggle-label {
            font-weight: 600;
            font-size: 1rem;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
        
        /* ----------------------------------- */
        /* 3. Main Content Layout (Mobile First) */
        /* ----------------------------------- */
        .page-content-wrapper {
            padding: 20px;
            min-height: 80vh;
        }
        
        /* The container for all dynamic content */
        #app-content {
            /* This is where Home, Post, or Menu pages will be rendered */
        }
        
        .post-container {
            display: grid;
            gap: 30px;
        }

        /* ----------------------------------- */
        /* 4. Post Card Styling (For Home & Recommended) */
        /* ----------------------------------- */
        .post-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex; 
            flex-direction: column;
            text-decoration: none;
            color: inherit;
        }

        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .night-mode .post-card:hover {
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        }
        
        /* **FIX 1: Horizontal Mobile Recommended Cards (100x150) ** */
        .post-card.small {
            flex-direction: row; 
            min-height: 100px;
            align-items: flex-start;
        }
        .post-card.small .post-image {
            height: 125px; 
            width: 100px; 
            flex-shrink: 0;
            border-radius: 12px 0 0 12px;
        }
        .post-card.small .post-content {
            padding: 10px 15px; 
            justify-content: space-between;
        }
        .post-card.small .post-title {
            font-size: 1rem; 
            margin-bottom: 3px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .post-card.small .post-description {
            display: none; 
        }
        .post-card.small .post-footer {
            padding-top: 5px;
            border-top: none; 
        }

        .post-image {
            width: 100%; 
            height: 200px;
            object-fit: cover;
        }

        .post-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .post-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .post-description {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 15px;
            flex-grow: 1; 
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: auto;
            font-size: 0.85rem;
            color: #777;
        }

        .read-link {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
            transition: color 0.2s;
        }

        .read-link:hover {
            color: #0056b3;
        }
        
        /* ----------------------------------- */
        /* 5. Full Post Page Content Styling */
        /* ----------------------------------- */
        .full-post {
            background: var(--card-bg);
            padding: 30px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            max-width: 100%; 
            margin: 0 auto;
            margin-bottom: 20px; 
        }
        
        /* **NEW: Social Interaction Bar Styles** */
        .post-social-bar {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px;
            margin: 30px 0 0 0; 
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .social-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f1f1;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1; 
            max-width: 150px;
            justify-content: center;
        }
        
        /* REMOVE HIGHLIGHTING/ACTIVE STATE as requested */
        .social-button:active {
            transform: none; 
            background-color: inherit !important; 
            color: inherit !important; 
            box-shadow: none; 
        }

        .social-button:hover {
            background: var(--primary-color);
            color: white;
        }
        .social-button i {
            font-size: 1.1rem;
        }
        .social-button.like:hover {
            background: #dc3545; 
        }
        
        .post-header-meta {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .post-main-title {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .post-main-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .post-highlight {
            background-color: #f0f8ff; 
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            font-style: italic;
            color: #333;
        }
        
        .post-paragraph {
            margin-bottom: 20px;
            font-size: 1.05rem;
        }
        
        .post-figure {
            margin: 20px 0;
            text-align: center;
        }
        
        .post-figure img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
        }
        
        .post-figure figcaption {
            font-size: 0.85rem;
            color: #777;
            margin-top: 10px;
        }
        
        /* Responsive Video Embeds */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            max-width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* ----------------------------------- */
        /* 6. Comments Section Styles (NEW) */
        /* ----------------------------------- */
        .comments-thread {
            margin-top: 25px;
            padding: 20px;
            border-top: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 8px;
            display: none; 
            overflow: hidden;
        }
        .night-mode .comments-thread {
             border-top: 1px solid #333;
        }

        .comments-thread.is-open {
            display: block;
        }

        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .comment-input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: var(--font-family);
            font-size: 1rem;
        }
        .night-mode .comment-input-area textarea {
            background-color: #333;
            color: white;
            border-color: #555;
        }

        .send-comment-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 48px;
            flex-shrink: 0;
        }

        .send-comment-button:hover {
            background-color: #0056b3;
        }

        .existing-comments-placeholder h4 {
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        /* ----------------------------------- */
        /* 7. Desktop Responsiveness */
        /* ----------------------------------- */
        @media (min-width: 768px) {
            
            /* Desktop Navigation (Horizontal) */
            .hamburger { display: none; }
            
            .header-right-content { /* NEW WRAPPER */
                display: flex;
                align-items: center;
                gap: 20px;
            }
            
            .nav-menu { 
                position: static; 
                width: auto; 
                height: auto; 
                transform: none; 
                background: transparent; 
                padding-top: 0; 
                box-shadow: none;
                flex-direction: row; /* Overwrite mobile column for desktop */
            }
            
            /* Hide user profile header on desktop */
            .user-profile-header {
                display: none;
            }
            
            .nav-menu ul { 
                display: flex; 
                gap: 5px; 
                padding: 0; 
                margin-top: 0; 
                border-top: none;
            }
            .nav-menu li a { 
                padding: 5px 10px; 
                color: var(--secondary-color); 
                border-bottom: none; 
            }
            .nav-menu li a:hover { 
                background-color: transparent; 
                color: var(--primary-color); 
                border-bottom: 2px solid var(--primary-color); 
            }
            .nav-menu li a i { display: none; }
            
            /* Desktop Toggle Positioning */
            .theme-toggle-container { 
                position: static;
                padding: 0;
                width: auto;
                background-color: transparent;
                border-top: none;
                color: var(--secondary-color);
            }
            .toggle-label {
                display: none; /* Hide label on desktop for a compact switch */
            }
            .night-mode .theme-toggle-container {
                color: var(--secondary-color); /* Light text on dark bg */
            }
            
            /* Social Bar adjustments */
            .post-social-bar {
                gap: 20px;
            }
            .social-button {
                flex-grow: 0;
            }

            /* Display the post card side-by-side (Image | Content) for Home Page */
            .post-card:not(.small) {
                flex-direction: row; 
                min-height: 240px; 
            }

            .post-card:not(.small) .post-image {
                width: 40%; 
                height: auto;
                max-height: 100%;
            }

            .post-card:not(.small) .post-content {
                width: 60%; 
                padding: 25px;
            }
            
            .post-title { font-size: 1.3rem; }
            
            .page-content-wrapper {
                max-width: 1400px;
                margin: 40px auto;
                padding: 0 40px;
            }
            
            /* Full Post Page adjustments */
            .full-post {
                padding: 40px;
                max-width: 100%; 
                box-shadow: none; 
                margin-bottom: 0; 
            }
            
            .post-main-title {
                font-size: 3rem;
            }
            
            .recommended-posts {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* ----------------------------------- */
        /* 8. Desktop Split Layout (Home Page: 70/30 | Post Page: 60/40) */
        /* ----------------------------------- */
        @media (min-width: 1024px) {
            
            .page-content-wrapper {
                display: flex;
                gap: 40px; 
            }
            
            /* Default Home/Generic Page Layout - 70% Content, 30% Read More */
            .main-content { 
                width: 70%;
            }
            
            .sidebar {
                display: block;
                width: 30%;
            }
            
            /* **POST PAGE SPECIFIC LAYOUT (60/40)** */
            .page-content-wrapper.post-page-60-40 .main-content {
                width: 60%; /* Post content takes 60% */
            }
            
            .page-content-wrapper.post-page-60-40 .sidebar {
                width: 40%; /* Recommended cards and adverts take 40% */
                display: block; 
            }

            .post-container {
                grid-template-columns: 1fr;
                gap: 30px;
                margin: 0;
            }
        }
        
        /* ----------------------------------- */
        /* 9. Full-Screen Compact Menu Modal Styles (NEW) */
        /* ----------------------------------- */
        .menu-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1500;
            overflow-y: auto;
            padding: 20px 0; 
        }

        .menu-modal.is-open {
            display: flex;
        }
        
        .modal-open-body {
            overflow: hidden !important;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            position: relative;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-inner {
            padding-top: 20px; 
        }

        .close-modal {
            position: sticky;
            top: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            line-height: 1;
            z-index: 1600;
            float: right;
            margin: -10px -10px 10px 0; 
        }

        .modal-section {
            padding: 30px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-section:last-child {
            border-bottom: none;
        }

        .modal-section h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        /* About Us: Author Profile (Picture, Name, Email side-by-side) */
        .author-info-compact {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .profile-image-compact {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            flex-shrink: 0;
        }

        .author-details {
            flex-grow: 1;
        }

        .author-details .profile-name {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .author-details p {
            font-size: 0.95rem;
            color: #555;
        }
        .night-mode .author-details p {
             color: #b0b0b0;
        }

        .author-details a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .modal-subsection-title {
            font-size: 1.3rem;
            color: var(--secondary-color);
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
        }
        .night-mode .modal-subsection-title {
             border-bottom: 1px dashed #555;
        }

        /* Newsletter: Stylish section (Wix-like update) */
        .newsletter-section-stylish {
            background-color: #f0f4f8; /* Light blue/gray background */
            border: 2px solid #3498db; /* Elegant Blue border */
            padding: 40px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .night-mode .newsletter-section-stylish {
             background-color: #1c2833;
             border-color: #4a90e2;
             color: #f1f1f1;
        }

        .newsletter-section-stylish h2 {
            color: #3498db;
            font-size: 2.2rem;
        }
        .night-mode .newsletter-section-stylish h2 {
             color: #4a90e2;
        }

        .newsletter-form-modal {
            display: flex;
            max-width: 450px;
            margin: 20px auto 0;
            gap: 10px;
        }

        .newsletter-form-modal input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 1rem;
        }
        .night-mode .newsletter-form-modal input {
             background-color: #333;
             color: white;
             border-color: #555;
        }

        .newsletter-form-modal button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .night-mode .newsletter-form-modal button {
             background-color: #4a90e2;
        }

        .newsletter-form-modal button:hover {
            background-color: #2980b9;
        }
        .night-mode .newsletter-form-modal button:hover {
            background-color: #3a7acb;
        }

        /* Contact: Social Icons and details */
        .contact-social-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .contact-social-icons a {
            font-size: 2rem;
            color: var(--secondary-color);
            transition: color 0.2s;
        }

        .contact-social-icons a:hover {
            color: var(--primary-color);
        }
        .contact-social-icons .fa-linkedin:hover { color: #0077b5; }
        .contact-social-icons .fa-x-twitter:hover { color: #000000; }
        .contact-social-icons .fa-instagram:hover { color: #E1306C; }
        .contact-social-icons .fa-dribbble:hover { color: #ea4c89; }
        .contact-social-icons .fa-github:hover { color: #171515; }

        .contact-details-compact {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
        }
        .night-mode .contact-details-compact {
             border: 1px solid #333;
        }

        .contact-details-compact div {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
            color: #333;
        }
        .night-mode .contact-details-compact div {
             color: #f1f1f1;
        }

        .contact-details-compact i {
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }

        .map-container-modal {
            height: 250px;
            width: 100%;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
        }

        .map-container-modal iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Responsive adjustment for modal content on smaller screens */
        @media (max-width: 600px) {
            .modal-content {
                padding: 15px;
                width: 95%;
            }
            .author-info-compact {
                flex-direction: column;
                text-align: center;
            }
            .author-details {
                text-align: center;
            }
            .close-modal {
                margin: -5px -5px 5px 0;
            }
        }
        
        /* Fix 1: Newsletter button cut-off fix for small mobile screens */
        @media (max-width: 480px) {
            .newsletter-form-modal {
                flex-direction: column;
            }
            .newsletter-form-modal input {
                margin-bottom: 10px;
            }
            .newsletter-form-modal input,
            .newsletter-form-modal button {
                width: 100%;
            }
        }
    </style>
    </head>
<body>

    <header class="main-header">
        <h1 class="blog-title" onclick="window.location.hash = '#home'">
            Digital <strong>Quill</strong>
        </h1>
        
        <div class="header-right-content">
            <button class="hamburger" aria-label="Toggle Navigation Menu">
                <span class="line line-top"></span>
                <span class="line line-middle"></span>
                <span class="line line-bottom"></span>
            </button>
    
            <nav class="nav-menu">
                <div class="user-profile-header">
                    <div class="user-info-placeholder">
                        <i class="fas fa-user-circle" style="font-size: 1.5rem; margin-right: 10px;"></i>
                        <div class="user-name">Guest User</div>
                        <div class="user-email">Log in to personalize</div>
                    </div>
                </div>
                <ul>
                    <li><a href="#menu/login" data-target="#modal-login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
                    <li><a href="#menu/about" data-target="#modal-about-me"><i class="fas fa-user-circle"></i> About Me</a></li>
                    <li><a href="#menu/newsletter" data-target="#modal-newsletter"><i class="fas fa-envelope-open-text"></i> Newsletter</a></li>
                    <li><a href="#menu/contact" data-target="#modal-contact"><i class="fas fa-phone"></i> Contact</a></li>
                </ul>
                
                <div class="theme-toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle-checkbox" aria-label="Toggle light and night mode">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-label">Night Mode</span>
                </div>
            </nav>
        </div>
        
    </header>

    <div class="page-content-wrapper">
        <div class="main-content">
            <div id="app-content">
            </div>
        </div>
        
        <aside class="sidebar">
        </aside>
    </div>
    
    <footer style="text-align: center; padding: 20px; color: #777;">
        © 2025 Digital Quill. All rights reserved.
    </footer>
    
    <div id="menu-modal" class="menu-modal">
        <div class="modal-content">
            <button class="close-modal" aria-label="Close Menu Modal">×</button>
            <div class="modal-inner">
                
                <section id="modal-login" class="modal-section">
                    <h2>Account Access</h2>
                    
                    <div id="login-form-container"> 
                        <h3 class="modal-subsection-title">Login to Your Account</h3>
                        <form id="login-form" class="auth-form" onsubmit="handleLoginSubmit(event)">
                            <input type="text" name="name" placeholder="Name or Email" required>
                            <input type="password" name="password" placeholder="Password" required>
                            <button type="submit" class="auth-button">Log In</button>
                            <p class="auth-link-text">
                                Don't have an account? 
                                <a href="#" onclick="showRegisterForm(event)">Create one</a>
                            </p>
                        </form>
                    </div>
                    
                    <div id="register-form-container" style="display: none;">
                        <h3 class="modal-subsection-title">Create a New Account</h3>
                        <form id="register-form" class="auth-form" onsubmit="handleRegisterSubmit(event)">
                            <input type="text" name="name" placeholder="Name" required>
                            <input type="email" name="email" placeholder="Email" required>
                            <input type="password" name="password" placeholder="Password" required>
                            <input type="password" name="confirm_password" placeholder="Confirm Password" required>
                            <button type="submit" class="auth-button">Register Account</button>
                            <p class="auth-link-text">
                                Already have an account? 
                                <a href="#" onclick="showLoginForm(event)">Login instead</a>
                            </p>
                        </form>
                    </div>
                </section>
                <section id="modal-about-me" class="modal-section">
                    <h2>About Me & The Blog</h2>
                    
                    <div class="author-info-compact">
                        <img src="https://picsum.photos/seed/profile/100/100" alt="Owner Profile Image" class="profile-image-compact">
                        <div class="author-details">
                            <h3 class="profile-name">Alex Vandelay</h3>
                            <p><i class="fas fa-envelope"></i> <a href="mailto:alex.vandelay@digitalquill.com">alex.vandelay@digitalquill.com</a></p>
                        </div>
                    </div>
                    
                    <h3 class="modal-subsection-title">About The Blog (Digital Quill)</h3>
                    <p>Digital Quill is my canvas for sharing both my creative works and the technical insights I gain along the way. I strive to make complex concepts simple and beautiful, blending the art of design with the science of code. Follow along for a unique perspective on the digital world.</p>
                    
                    </section>
                
                <section id="modal-newsletter" class="modal-section newsletter-section-stylish">
                    <h2>Subscribe to My Stylish Newsletter</h2>
                    <p>Join the Stylish Artist's monthly collection of creative posts, art inspiration, and behind-the-scenes insights.</p>
                    <form class="newsletter-form-modal" onsubmit="alert('Thank you for subscribing, ' + this.elements['email'].value + '!'); return false;">
                        <input type="email" name="email" placeholder="Enter your email address" required>
                        <button type="submit">Subscribe <i class="fas fa-arrow-right"></i></button>
                    </form>
                </section>
                
                <section id="modal-contact" class="modal-section">
                    <h2>Get In Touch</h2>
                    
                    <div class="contact-social-icons">
                        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                        <a href="#" aria-label="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" aria-label="Dribbble"><i class="fab fa-dribbble"></i></a>
                        <a href="#" aria-label="GitHub"><i class="fab fa-github"></i></a>
                    </div>
                    
                    <div class="contact-details-compact">
                        <div><i class="fas fa-phone"></i> <span>(555) 123-4567 (Author)</span></div>
                        <div><i class="fas fa-envelope"></i> <span><a href="mailto:alex.vandelay@digitalquill.com">alex.vandelay@digitalquill.com</a></span></div>
                        <div><i class="fas fa-map-marker-alt"></i> <span>123 Google Board Address, Creative City, 90210</span></div>
                    </div>
                    
                    <div class="map-container-modal">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3021.139626578018!2d-73.97394348459424!3d40.78132407932646!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c2589a1af478c1%3A0x1d211cc5d33682de!2sThe%20Metropolitan%20Museum%20of%20Art!5e0!3m2!1sen!2sus!4v1677840000000!5m2!1sen!2sus" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                </section>
                
            </div>
        </div>
        
    </div>
    
  
    <script>
        // --- Global State & Configuration ---
        // CRITICAL: Replace this with your actual deployed Apps Script Web App URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZBS6r5r88Wcp0perxnPP36MDr1RFooGIkyE6qOhNW1-A_Ngis_-QPdmkrRHFWu0EqPA/exec'; 

        // Data Storage
        let blogPosts = [];
        let siteContent = {}; // Stores About/Contact content
        let userLikes = []; // Stores IDs of posts liked by the current user
        let userComments = {}; // Tracks if user has commented on a post: {postId: true}

        // Pagination State for Infinite Scrolling
        let currentPage = 1; 
        const POSTS_PER_PAGE = 10; // Number of posts to load per batch
        let allPostsLoaded = false; 
        let postObserver = null; 

        // User State (Initialized from Local Storage)
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let isLoggedIn = !!currentUser; // True if currentUser is not null

        // Modal Elements
        const menuModal = document.getElementById('menu-modal');
        const modalInner = document.querySelector('.modal-inner');
        let audioContext;
        
        // --- API & Utility Functions ---

        /**
         * Unified function to communicate with the Apps Script backend.
         */
        async function callAppScript(action, data = {}) {
            const url = `${APPS_SCRIPT_URL}?action=${action}`;
            try {
                const response = await fetch(url, {
                    method: data.method || 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    body: data.body ? JSON.stringify(data.body) : null
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.message || 'An API error occurred.');
                }
                return result.data;
            } catch (error) {
                console.error(`[API Error - ${action}]:`, error);
                return { status: 'error', message: error.message };
            }
        }
        
        /**
         * Fetches initial user state (likes/comments) after login.
         */
        async function fetchUserState(userId) {
            const likeData = await callAppScript('getUserLikes', { method: 'POST', body: { userId } });
            userLikes = likeData.map(l => l.postId) || [];
            
            const commentData = await callAppScript('getUserComments', { method: 'POST', body: { userId } });
            userComments = {};
            commentData.forEach(c => {
                 // Mark the post as commented on
                 userComments[c.postId] = true; 
            });
        }

        // --- INFINITE SCROLLING CORE LOGIC ---

        function cleanupObserver() {
            if (postObserver) {
                postObserver.disconnect();
                postObserver = null;
            }
            const sentinel = document.getElementById('infinite-scroll-sentinel');
            if (sentinel) sentinel.remove();
            const endMessage = document.getElementById('end-of-content-msg');
            if (endMessage) endMessage.remove();
        }

        function setupInfiniteScroll(container) {
            cleanupObserver();

            if (allPostsLoaded) {
                const endMessage = document.createElement('p');
                endMessage.id = 'end-of-content-msg';
                endMessage.textContent = "You've reached the end of the blog!";
                endMessage.style.cssText = 'text-align: center; color: #777; margin: 30px auto; font-style: italic;';
                container.appendChild(endMessage);
                return;
            }

            const sentinel = document.createElement('div');
            sentinel.id = 'infinite-scroll-sentinel';
            sentinel.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading more...</p>';
            sentinel.style.minHeight = '50px'; 
            container.appendChild(sentinel);

            postObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !allPostsLoaded) {
                        postObserver.unobserve(entry.target); 
                        
                        currentPage++; 
                        
                        fetchBlogPosts(true).then(() => {
                            if (!allPostsLoaded) {
                                postObserver.observe(entry.target);
                            } else {
                                cleanupObserver();
                            }
                        });
                    }
                });
            }, {
                rootMargin: '0px 0px 100px 0px' 
            });

            postObserver.observe(sentinel);
        }

        // --- DATA FETCHING CORE ---

        async function fetchBlogPosts(isNewPage = false) {
            if (allPostsLoaded && isNewPage) return;

            const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
            
            const data = await callAppScript('getPosts', { method: 'GET', body: { start: startIndex, limit: POSTS_PER_PAGE } });
            
            if (data.status === 'error') {
                 // Handled in callAppScript, just exit
                 if (!isNewPage) {
                     document.getElementById('app-content').innerHTML = '<div style="padding: 50px; text-align: center; color: #d9534f;">Failed to load posts.</div>';
                 }
                 return;
            }

            const newPosts = data.posts || [];
            
            if (isNewPage) {
                blogPosts = [...blogPosts, ...newPosts]; 
            } else {
                blogPosts = newPosts;
                allPostsLoaded = false;
            }
            
            if (newPosts.length < POSTS_PER_PAGE) {
                allPostsLoaded = true;
            }

            const isHomeRoute = window.location.hash === '#home' || window.location.hash === '';
            if (isHomeRoute) {
                 renderHomePage(isNewPage); 
            }
        }
        
        async function fetchSiteContent() {
             const data = await callAppScript('getPages');
             if (data.status !== 'error' && data.content) {
                 siteContent = data.content;
             }
        }

        // --- AUTHENTICATION & PERSISTENCE ---

        function updateLocalStorage(user) {
            currentUser = user;
            isLoggedIn = !!user;
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                fetchUserState(user.userId); // Fetch user-specific data right away
            } else {
                localStorage.removeItem('currentUser');
                userLikes = [];
                userComments = {};
            }
            updateUserProfileHeader();
        }

        function handleLoginSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const email = form.elements['email'].value;
            const password = form.elements['password'].value;
            
            callAppScript('loginUser', { method: 'POST', body: { email, password } }).then(result => {
                if (result.status === 'success') {
                    updateLocalStorage(result.user);
                    alert(`Login successful! Welcome back, ${result.user.name}!`);
                    closeMenuModal();
                } else {
                    alert(`Login failed: ${result.message}`);
                }
            });
        }
        
        function handleRegisterSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const name = form.elements['name'].value;
            const email = form.elements['email'].value;
            const password = form.elements['password'].value;
            const confirmPassword = form.elements['confirm_password'].value;
            
            if (password.length < 6) {
                alert('Error: Password must be at least 6 characters.');
                return;
            }
            if (password !== confirmPassword) {
                alert('Error: Passwords do not match!');
                return;
            }

            // Check Local Storage for existing sign up attempt (simplistic local check)
            if (localStorage.getItem(email)) {
                 alert('Error: An account with this email has recently been created. Please log in.');
                 return;
            }

            callAppScript('registerUser', { method: 'POST', body: { name, email, password } }).then(result => {
                if (result.status === 'success') {
                    localStorage.setItem(email, 'registered'); // Set local flag
                    alert(`Registration successful! Account created for ${name}. Please log in.`);
                    showLoginForm();
                } else {
                    alert(`Registration failed: ${result.message}`);
                }
            });
        }
        
        function handleLogout(e) {
            if(e) e.preventDefault();
            updateLocalStorage(null);
            alert('You have been logged out.');
            if (window.location.hash.startsWith('#menu')) {
                window.location.hash = '#home';
            }
        }

        // --- INTERACTION LOGIC (Like/Comment) ---

        async function handleLikeToggle(postId) {
            if (!isLoggedIn) {
                showLoginPrompt();
                return;
            }

            const isCurrentlyLiked = userLikes.includes(postId);
            const action = isCurrentlyLiked ? 'unlike' : 'like';

            const result = await callAppScript('toggleLike', { method: 'POST', body: { postId, userId: currentUser.userId, action } });

            if (result.status === 'success') {
                const likeButton = document.querySelector(`.social-button.like[data-post-id="${postId}"]`);

                if (action === 'like') {
                    userLikes.push(postId);
                    likeButton.classList.add('is-liked');
                    likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
                } else {
                    userLikes = userLikes.filter(id => id !== postId);
                    likeButton.classList.remove('is-liked');
                    likeButton.innerHTML = '<i class="fas fa-heart"></i> Like';
                }
            } else {
                alert('Failed to update like status: ' + result.message);
            }
        }

        async function handleCommentSubmit(event, postId) {
            event.preventDefault();
            if (!isLoggedIn) {
                showLoginPrompt();
                return;
            }
            
            // Single Comment Restriction
            if (userComments[postId]) {
                 alert('You have already submitted a comment on this post. Your comment is pending approval or already published.');
                 return;
            }

            const commentArea = event.target.closest('.comment-input-area').querySelector('textarea');
            const commentText = commentArea.value.trim();

            if (commentText === '') {
                alert('Please write a comment before sending.');
                return;
            }

            const result = await callAppScript('postComment', { method: 'POST', body: { postId, userId: currentUser.userId, commentText } });

            if (result.status === 'success') {
                userComments[postId] = true; // Mark as commented
                alert('Comment submitted successfully! It is now pending admin approval.');
                commentArea.value = '';
                // Disable the send button/textarea until status is cleared (e.g., page refresh)
                commentArea.disabled = true;
                event.target.closest('.send-comment-button').disabled = true;

            } else {
                alert('Failed to submit comment: ' + result.message);
            }
        }

        // --- CONTENT RENDERING HELPERS ---
        
        /**
         * Parses and renders text with basic formatting (B, U, I).
         * @param {string} text 
         */
        function parseFormattedText(text) {
             if (!text) return '';
             // Use simple regex replacement for inline formatting
             text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // **bold**
             text = text.replace(/__(.*?)__/g, '<u>$1</u>');   // __underline__
             text = text.replace(/_(.*?)_/g, '<i>$1</i>');     // _italics_
             return text;
        }

        /**
         * Generates the HTML for the post content, including Ad insertion.
         */
        function renderPostContent(post) {
            let html = '';
            let wordCount = 0;
            const AD_WORD_INTERVAL = 400;
            const AD_SLOT_ID = 'AD-SLOT-1'; // Static ID for ad fetching (or dynamic based on admin sheet)
            
            // Build the Table of Contents first
            const toc = [];
            let headerIndex = 0;
            post.content.forEach(block => {
                if (block.type === 'header') {
                    headerIndex++;
                    const anchorId = `section-${headerIndex}`;
                    toc.push({ text: block.text, id: anchorId });
                    block.anchorId = anchorId; // Add anchor to block for rendering
                }
            });

            // 1. Render TOC
            if (toc.length > 1) {
                html += '<div class="post-toc"><h4>Table of Contents</h4><ul>';
                toc.forEach(item => {
                    html += `<li><a href="#${item.id}">${item.text}</a></li>`;
                });
                html += '</ul></div>';
            }

            // 2. Render Main Content and insert Ads
            post.content.forEach(block => {
                let blockHtml = '';
                
                switch(block.type) {
                    case 'paragraph':
                        const text = parseFormattedText(block.text);
                        blockHtml = `<p class="post-paragraph">${text}</p>`;
                        wordCount += block.text.split(/\s+/).length;
                        break;
                    case 'header':
                        const anchor = block.anchorId ? `id="${block.anchorId}"` : '';
                        blockHtml = `<h2 class="post-main-header" ${anchor}>${block.text}</h2>`;
                        break;
                    case 'image':
                        // Note: block.url comes from Google Drive link via Apps Script
                        blockHtml = `
                            <figure class="post-figure">
                                <img src="${block.url}" alt="${block.caption || 'Post image'}">
                                <figcaption>${block.caption || ''}</figcaption>
                            </figure>
                        `;
                        break;
                    case 'video':
                        const youtubeId = getYouTubeId(block.url);
                        if (youtubeId) {
                            blockHtml = `<figure class="post-figure"><div class="video-container"><iframe src="https://www.youtube.com/embed/${youtubeId}?rel=0" allowfullscreen></iframe></div><figcaption>${block.caption || 'Embedded Video'}</figcaption></figure>`;
                        }
                        break;
                    case 'link':
                        // Custom link block (can be implemented in admin)
                        blockHtml = `<p class="post-paragraph"><a href="${block.url}" target="_blank" class="external-link">${block.text || block.url}</a></p>`;
                        break;
                }

                html += blockHtml;

                // Ad Insertion Logic
                if (block.type === 'paragraph' && wordCount >= AD_WORD_INTERVAL) {
                    // Reset word count and insert ad slot
                    wordCount = 0;
                    html += `<div class="inline-ad-slot" data-ad-id="${AD_SLOT_ID}">Loading Ad...</div>`; 
                }
            });

            return html;
        }

        // --- POST PAGE & RECOMMENDED LOGIC ---

        /**
         * Uses a simple keyword matching algorithm for "Read More" posts.
         */
        function getRecommendedPosts(currentPost) {
            const currentPostKeywords = (currentPost.keywords || '').split(',').map(k => k.trim().toLowerCase());
            
            // Calculate a score for every other post
            const scoredPosts = blogPosts
                .filter(p => p.id !== currentPost.id)
                .map(post => {
                    const postKeywords = (post.keywords || '').split(',').map(k => k.trim().toLowerCase());
                    let score = 0;
                    
                    // Simple intersection count
                    currentPostKeywords.forEach(keyword => {
                        if (postKeywords.includes(keyword)) {
                            score++;
                        }
                    });
                    
                    // Also check for keyword match in the title
                    if (currentPostKeywords.some(k => post.title.toLowerCase().includes(k))) {
                        score += 2;
                    }
                    
                    return { post, score };
                })
                .filter(item => item.score > 0) // Only show posts with some match
                .sort((a, b) => b.score - a.score) // Sort descending by score
                .slice(0, 5) // Max 5 recommendations
                .map(item => item.post);
                
            return scoredPosts;
        }

        /**
         * 3. Post Page Renderer (Fulfills the core request)
         */
        async function renderPostPage(postId) {
            clearAppContent();
            const appContent = document.getElementById('app-content');
            
            // Attempt to find the post in the currently loaded cache
            let post = blogPosts.find(p => p.id == postId);
            
            if (!post) {
                // FALLBACK: If not found, fetch the single post details directly
                const result = await callAppScript('getPostDetail', { method: 'GET', body: { postId } });
                post = result.post;
            }

            if (!post) {
                // Post not found in cache or backend
                // ... (404 logic) ...
                return;
            }
            
            // --- Post Setup and Rendering ---

            // CRITICAL: Ensure the complex 'content' string from the sheet is parsed
            try {
                 post.content = JSON.parse(post.content);
            } catch (e) {
                 console.error("Failed to parse post content JSON:", e);
                 post.content = [{ type: 'paragraph', text: 'Error: Content structure corrupted.' }];
            }

            // Update visit count (Async, fire and forget)
            callAppScript('trackVisit', { method: 'POST', body: { postId } }); 

            // Apply 60/40 layout class
            document.querySelector('.page-content-wrapper').classList.add('post-page-60-40');
            document.querySelector('.sidebar').style.display = 'block'; 
            
            const formattedDate = new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const postHTML = document.createElement('article');
            postHTML.classList.add('full-post');
            
            // --- Article Header ---
            let content = `
                <div class="post-header-meta">${formattedDate} • ${post.readTime}</div>
                <h1 class="post-main-title">${post.title}</h1>
                <p style="text-align:center; font-style:italic; color:#555; margin-bottom: 30px;">${post.header || post.description}</p>
            `;
            
            // --- Highlights ---
            if (post.highlights && post.highlights.length > 0) {
                // Need to parse highlights if stored as JSON string
                let highlights = post.highlights;
                try {
                    if (typeof highlights === 'string') highlights = JSON.parse(highlights);
                } catch (e) { /* ignore */ }
                
                content += '<div class="post-highlight"><ul>';
                highlights.forEach(highlight => {
                    content += `<li><i class="fas fa-hand-point-right"></i> ${highlight}</li>`;
                });
                content += '</ul></div>';
            }
            
            // --- Main Content Loop (NEW: Renders all content types, ads, and TOC) ---
            content += renderPostContent(post);

            // --- Post Social Bar and Comments Section ---
            const isLiked = userLikes.includes(post.id);
            const likedClass = isLiked ? 'is-liked' : '';
            const likeText = isLiked ? 'Liked' : 'Like';
            
            // Get comments (Placeholder for now, implementation needs another API call)
            const commentsResult = await callAppScript('getComments', { method: 'GET', body: { postId, status: 'APPROVED' } });
            const comments = commentsResult.comments || [];

            const socialBarAndCommentsHtml = `
                <div class="post-social-bar">
                    <button class="social-button like ${likedClass}" data-post-id="${post.id}" onclick="handleLikeToggle(${post.id})"><i class="fas fa-heart"></i> ${likeText}</button>
                    <button class="social-button share" data-post-id="${post.id}" onclick="handleShareClick(this, ${post.id})"><i class="fas fa-share-alt"></i> Share</button>
                    <button class="social-button comment-toggle" data-post-id="${post.id}" onclick="handleCommentToggle(${post.id})"><i class="fas fa-comment"></i> Comment (${comments.length})</button>
                </div>
                
                <div id="comments-thread-${post.id}" class="comments-thread">
                    <div class="comment-input-area">
                        <textarea placeholder="Write a comment..." rows="3" ${userComments[post.id] ? 'disabled' : ''}></textarea>
                        <button class="send-comment-button" ${userComments[post.id] ? 'disabled' : ''} onclick="handleCommentSubmit(event, ${post.id})"><i class="fas fa-paper-plane"></i> Send</button>
                        ${userComments[post.id] ? '<p style="color:red; font-size: 0.9em; margin-top: 10px;">You have already submitted a comment.</p>' : ''}
                    </div>
                    <div class="existing-comments-placeholder">
                        <h4>${comments.length} Comments</h4>
                        ${comments.length === 0 ? '<p style="color:#777; margin-top: 10px;">Be the first to comment!</p>' : ''}
                        ${comments.map(c => `
                            <div class="single-comment">
                                <span class="comment-author">${c.name}</span>
                                <span class="comment-date">${new Date(c.commentDate).toLocaleDateString()}</span>
                                <p class="comment-text">${c.commentText}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            content += socialBarAndCommentsHtml; 
            postHTML.innerHTML = content;
            appContent.appendChild(postHTML);
            
            // --- Sidebar Content: Recommended Posts ---
            const sidebar = document.querySelector('.sidebar');
            const recommended = getRecommendedPosts(post);
            
            let sidebarContent = '';
            
            if (recommended.length > 0) {
                 sidebarContent += `
                    <div class="sidebar-card">
                        <h3>More to Read</h3>
                        <div class="recommended-posts-sidebar" style="display: grid; gap: 15px;">
                `;
                recommended.forEach(recPost => {
                    sidebarContent += createPostCard(recPost, true).outerHTML; 
                });
                sidebarContent += '</div></div>';
            }
            
            // Advert Placeholder (Sidebar 300x250)
            sidebarContent += `
                <div class="sidebar-card" style="margin-top: 30px;">
                    <div style="height: 250px; background-color: #ffcdd2; color: #d32f2f; display: flex; align-items: center; justify-content: center; font-weight: 600; border-radius: 4px; box-shadow: var(--shadow-light);">
                        40% Ad Space - 300x250 Banner
                    </div>
                </div>
            `;
            
            sidebar.innerHTML = sidebarContent;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Execute Ad Code (Need to fetch ad code from Apps Sheet)
            // Note: This needs a dedicated fetch for AD_SLOT-1 code and insertion via innerHTML.
        }

        // --- Other Page Renderers (About/Contact) ---
        
        function renderContentModal(title, contentKey) {
            const content = siteContent[contentKey] || [{type: 'paragraph', text: 'Content not available.'}];
            const section = document.querySelector('#modal-about-me.modal-section') || document.querySelector('#modal-contact.modal-section');
            if (!section) return;

            section.querySelector('h2').textContent = title;
            const contentDiv = section.querySelector('.modal-body-content');
            
            let html = '';
            content.forEach(block => {
                 const text = parseFormattedText(block.text);
                 html += `<p class="post-paragraph">${text}</p>`;
            });

            contentDiv.innerHTML = html;
        }


        // --- Final Router/Init ---

        function router() {
            const hash = window.location.hash || '#home';
            const [base, param] = hash.substring(1).split('/'); 

            if (!base.startsWith('menu')) {
                 closeMenuModal();
            }

            if (base === 'home' || base === '') {
                // Reset pagination state on navigation to home
                currentPage = 1; 
                allPostsLoaded = false;
                
                renderHomePage(false); 
                fetchBlogPosts(false); 

            } else if (base === 'post' && param) {
                renderPostPage(param);
            } else if (base === 'menu' && param) {
                // Menu modal trigger logic: Open modal and scroll to section
                let targetId;
                if (param === 'login') {
                    targetId = '#modal-login';
                    setTimeout(() => { showLoginForm(); }, 0); 
                }
                else if (param === 'about') {
                    targetId = '#modal-about';
                    renderContentModal('About Us', 'aboutContentJSON');
                }
                else if (param === 'contact') {
                    targetId = '#modal-contact';
                    renderContentModal('Contact Us', 'contactContentJSON');
                }
                else if (param === 'newsletter') targetId = '#modal-newsletter'; // Assuming this remains static form
                
                if (targetId) {
                    openMenuModal(targetId);
                }
            } else {
                // ... (404 logic) ...
            }
            
            if (document.body.classList.contains('menu-open')) {
                toggleMenu();
            }
        }
        
        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
             // 1. Setup Theme
             setupThemeToggle();
             
             // 2. Setup User Profile Header (Initial state: Guest or Logged in from LS)
             updateUserProfileHeader();
             if (isLoggedIn) {
                 fetchUserState(currentUser.userId);
             }

             // 3. Fetch static content for modals
             fetchSiteContent();
             
             // 4. Setup Router
             if (!window.location.hash || window.location.hash === '#home') {
                 window.location.hash = '#home';
             } else {
                 router(); 
             }
        });

        // The rest of your existing functions (playClickSound, getYouTubeId, clearAppContent, 
        // handleCommentToggle, handleShareClick, attachPostPageListeners, 
        // showLoginForm, showRegisterForm, showLoginPrompt, handleInteractionClick,
        // openMenuModal, closeMenuModal, createPostCard, renderHomePage, 
        // toggleMenu, setupThemeToggle, and their event listeners)
        // should be placed here, updated to use the new global state and API calls.
        
        // (Due to length constraints, the existing functions are omitted but assumed to be present
        // and updated as per the detailed logic shown above in the core functions.)
        // E.g., renderHomePage now calls setupInfiniteScroll(appContent) instead of looping all posts.

        // ... [Insert all remaining original/updated helper functions here] ...
    </script>
</body>
</html>
